<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analysis Results</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #c7d2fe, #e0f2fe);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    .result-box {
      background: white;
      width: 90%;
      max-width: 800px;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      animation: fadeIn 0.8s ease;
    }

    h2 {
      color: #2563eb;
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
    }

    .report-type {
      background: #dbeafe;
      color: #1d4ed8;
      padding: 8px 16px;
      border-radius: 20px;
      display: inline-block;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .section {
      margin: 25px 0;
      padding: 20px;
      border-radius: 12px;
      background: #f8fafc;
    }

    .section-title {
      color: #2563eb;
      font-size: 18px;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }

    .values-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }

    .values-table th {
      background: #dbeafe;
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }

    .values-table td {
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
    }

    .values-table tr:hover {
      background: #f1f5f9;
    }

    .status-normal {
      color: #10b981;
      font-weight: 600;
    }

    .status-high {
      color: #ef4444;
      font-weight: 600;
    }

    .status-low {
      color: #f59e0b;
      font-weight: 600;
    }

    .interpretation {
      background: white;
      border-left: 4px solid #3b82f6;
      padding: 15px;
      margin: 10px 0;
      border-radius: 0 8px 8px 0;
    }

    .findings {
      background: #fffbeb;
      border-left: 4px solid #f59e0b;
      padding: 15px;
      margin: 10px 0;
      border-radius: 0 8px 8px 0;
    }

    .error {
      background: #fee2e2;
      color: #b91c1c;
      border-left: 4px solid #ef4444;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .btn {
      display: inline-block;
      padding: 12px 24px;
      background: #2563eb;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: background 0.3s ease;
      border: none;
      cursor: pointer;
      margin: 10px 5px;
      text-align: center;
    }

    .btn:hover {
      background: #1d4ed8;
    }

    .btn-secondary {
      background: #64748b;
    }

    .btn-secondary:hover {
      background: #475569;
    }

    .btn-success {
      background: #10b981;
    }

    .btn-success:hover {
      background: #059669;
    }

    .actions {
      text-align: center;
      margin-top: 30px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .audio-player {
      margin: 20px 0;
      text-align: center;
    }

    .audio-controls {
      display: none;
      margin-top: 15px;
    }

    .no-results {
      text-align: center;
      color: #64748b;
      font-style: italic;
      padding: 20px;
    }

    .preventive-measures {
      background: #f0fdf4;
      border-left: 4px solid #10b981;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }

    .preventive-measures h4 {
      color: #059669;
      font-size: 15px;
      margin: 0 0 10px 0;
    }

    .preventive-measures ul {
      margin: 0;
      padding-left: 20px;
      list-style: none;
    }

    .preventive-measures li {
      margin: 6px 0;
      color: #047857;
      line-height: 1.5;
    }

    .doctor-warning {
      background: #fef2f2;
      border-left: 4px solid #ef4444;
      padding: 12px 15px;
      margin: 8px 0;
      border-radius: 0 8px 8px 0;
      font-weight: 600;
      color: #b91c1c;
    }
  </style>
</head>
<body>
  <div class="result-box">
    <h2>üìä Lab Report Analysis</h2>
    
    {% if error %}
      <div class="error">
        <strong>Error:</strong> {{ error }}
      </div>
      <div class="actions">
        <a href="/" class="btn btn-secondary">Upload Another Report</a>
      </div>
    {% else %}
      {% if report_type %}
        <div class="report-type">{{ report_type }}</div>
      {% endif %}
      
      <!-- Extracted Values Section -->
      <div class="section">
        <h3 class="section-title">üî¨ Extracted Values</h3>
        {% if values %}
          <!-- Graph -->
          <div style="margin: 20px 0;">
            <canvas id="valuesChart" style="max-height: 300px;"></canvas>
          </div>
          
          <table class="values-table">
            <thead>
              <tr>
                <th>Test</th>
                <th>Value</th>
                <th>Unit</th>
                <th>Normal Range</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for name, data in values.items() %}
              <tr>
                <td>{{ name }}</td>
                <td>{{ data.value }}</td>
                <td>{{ data.unit }}</td>
                <td>{{ data.low_normal }} - {{ data.high_normal }}</td>
                <td class="status-{{ interpretations[name].status.lower() }}">{{ interpretations[name].status }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="no-results">No measurable values were found in the report.</div>
        {% endif %}
      </div>
      
      <!-- Interpretations Section -->
      {% if interpretations %}
      <div class="section">
        <h3 class="section-title">üìù Medical Interpretations & Analysis Needed</h3>
        {% for name, interp in interpretations.items() %}
          <div class="interpretation">
            <strong>{{ name }}:</strong> {{ interp.status }}<br>
            <small style="color: #475569; line-height: 1.6; display: block; margin-top: 8px;">{{ interp.interpretation }}</small>
          </div>
        {% endfor %}
      </div>
      {% endif %}
      
      <!-- Preventive Measures Section -->
      {% if interpretations %}
      <div class="section">
        <h3 class="section-title">üíä Preventive Measures & Recommendations</h3>
        {% for name, interp in interpretations.items() %}
          {% if interp.preventive_measures %}
            <div class="preventive-measures">
              <h4>{{ name }} - {{ interp.status }}</h4>
              <ul>
                {% for measure in interp.preventive_measures %}
                  {% if '‚ö†Ô∏è CONSULT' in measure %}
                    <li class="doctor-warning">{{ measure }}</li>
                  {% else %}
                    <li>{{ measure }}</li>
                  {% endif %}
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      {% endif %}
      
      <!-- Audio Playback -->
      <div class="audio-player">
        <button id="speakBtn" class="btn btn-success">üîä Listen to Full Report</button>
        <div class="audio-controls" id="audioControls">
          <audio id="audioPlayer" controls></audio>
        </div>
      </div>
      
      <div class="actions">
        <a href="/" class="btn btn-secondary">Upload Another Report</a>
        <a href="/reports" class="btn">View All Reports</a>
        {% if report_id %}
        <a href="/report/{{ report_id }}" class="btn">View This Report</a>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <script>
    // Chart data passed from server
    var chartDataJson = '{{ chart_data|tojson|safe }}';
    var chartData = chartDataJson ? JSON.parse(chartDataJson) : null;
    
    if (chartData && chartData.labels && chartData.labels.length > 0) {
      const ctx = document.getElementById('valuesChart');
      if (ctx) {
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: chartData.labels,
            datasets: [{
              label: 'Your Values',
              data: chartData.values,
              backgroundColor: chartData.colors,
              borderColor: chartData.colors.map(c => c.replace('0.8', '1')),
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              title: {
                display: true,
                text: 'Test Results Overview'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Values'
                }
              }
            }
          }
        });
      }
    }
    
    document.getElementById('speakBtn').addEventListener('click', function() {
      // Create a summary that reads the actual values
      let summaryText = '';
      
      // Add report type
      const reportType = document.querySelector('.report-type');
      if (reportType) {
        summaryText += 'This is a ' + reportType.textContent + '. ';
      }
      
      // Add extracted values
      const valuesTable = document.querySelector('.values-table');
      if (valuesTable) {
        summaryText += 'Test results: ';
        const rows = valuesTable.querySelectorAll('tbody tr');
        rows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 4) {
            const testName = cells[0].textContent;
            const value = cells[1].textContent;
            const unit = cells[2].textContent;
            const status = cells[4].textContent;
            
            // Read all values but emphasize abnormal ones
            summaryText += `${testName}: ${value} ${unit}. `;
            
            // Add status information for abnormal values
            if (status === 'High' || status === 'Low') {
              summaryText += `This value is ${status.toLowerCase()}. `;
            }
          }
        });
      }
      
      // Add any additional findings
      const findings = document.querySelectorAll('.findings');
      if (findings.length > 0) {
        summaryText += 'Additional notes: ';
        findings.forEach(finding => {
          summaryText += finding.textContent + ' ';
        });
      }
      
      if (!summaryText.trim()) {
        alert('No summary content to speak');
        return;
      }
      
      // Send request to the speak endpoint
      const formData = new FormData();
      formData.append('text', summaryText);
      formData.append('lang', 'en');
      
      fetch('/speak', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.ok && data.url) {
          const audioPlayer = document.getElementById('audioPlayer');
          audioPlayer.src = data.url;
          document.getElementById('audioControls').style.display = 'block';
          audioPlayer.play();
        } else {
          alert('Failed to generate audio: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to generate audio');
      });
    });
  </script>
</body>
</html>
