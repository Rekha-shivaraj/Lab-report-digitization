<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ report_type }} Summary</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0f2fe, #f9fafb);
      margin: 0; padding: 36px; color: #1e293b;
    }
    .container {
      max-width: 900px; margin: auto;
      background: #fff; padding: 28px; border-radius: 18px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }
    h1 { text-align:center; color:#2563eb; margin-bottom:8px; font-size:30px; }
    .status { text-align:center; padding:12px; border-radius:10px; font-weight:600; margin:18px 0; text-transform:capitalize; }
    .status.normal { background:#dcfce7; color:#166534; }
    .status.attention { background:#fee2e2; color:#991b1b; }

    .summary-box { background:#f8fafc; border-left:6px solid #2563eb; padding:18px; border-radius:12px; margin-bottom:20px; line-height:1.6; font-size:17px; }
    .chart-section { background:#f1f5f9; padding:20px; border-radius:12px; margin-bottom:22px; }
    canvas { width:100% !important; height:360px !important; }
    .buttons { text-align:center; margin-top:16px; }
    button, a.btn {
      background:#2563eb; color:white; padding:10px 20px; border-radius:10px; border:none; margin:8px; cursor:pointer; text-decoration:none;
    }
    button:hover, a.btn:hover { background:#1e40af; }
  </style>
</head>
<body>
  <div class="container">
    <h1>{{ report_type }}</h1>

    <div class="status {{ overall_status }}">
      {% if overall_status == 'normal' %}
        ‚úÖ All results appear normal.
      {% else %}
        ‚ö†Ô∏è Some results need attention.
      {% endif %}
    </div>

    <div class="summary-box" id="summaryBox">
      <strong>Summary:</strong><br>
      <!-- render summary_text into DOM so JS can read it safely -->
      <div id="summaryText">{{ summary_text }}</div>
    </div>

    {% if chart_data %}
      <!-- Safe storage of JSON data in DOM (not inside JS code) -->
      <script id="chart-data" type="application/json">{{ chart_data | tojson | safe }}</script>

      <div class="chart-section">
        <h3 style="text-align:center;color:#1e3a8a;margin-bottom:10px;">Test Results</h3>
        <canvas id="labChart" aria-label="Lab test results chart" role="img"></canvas>
      </div>
    {% endif %}

    <div class="buttons">
      <button id="playBtn">üîä Hear My Report</button>
      <a href="/" class="btn">‚¨ÖÔ∏è Upload Another</a>
    </div>
  </div>

  <script>
    // Read summary text safely from the DOM (NO tojson used here)
    function speakReport() {
      const summary = document.getElementById('summaryText').innerText || '';
      if (!summary.trim()) { alert('No summary available to speak.'); return; }
      const utter = new SpeechSynthesisUtterance(summary);
      utter.lang = 'en-US';
      utter.rate = 1.0;
      speechSynthesis.speak(utter);
    }

    document.getElementById('playBtn').addEventListener('click', speakReport);

    // Chart: get JSON from <script type="application/json"> and parse it
    (function renderChartFromDOM() {
      const script = document.getElementById('chart-data');
      if (!script) return; // no chart data available

      let chartData = [];
      try {
        chartData = JSON.parse(script.textContent || '[]');
      } catch (err) {
        console.error('Invalid chart JSON:', err);
        return;
      }
      if (!Array.isArray(chartData) || chartData.length === 0) return;

      const labels = chartData.map(d => d.name || 'Test');
      const values = chartData.map(d => (typeof d.value === 'number') ? d.value : 0);
      const bgColors = chartData.map(d => (d.value < d.low || d.value > d.high) ? '#ef4444' : '#22c55e');

      const ctx = document.getElementById('labChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Value',
            data: values,
            backgroundColor: bgColors,
            borderRadius: 8
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    })();
  </script>
</body>
</html>
